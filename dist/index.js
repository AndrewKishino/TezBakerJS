!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var o=t();for(var n in o)("object"==typeof exports?exports:e)[n]=o[n]}}(global,function(){return function(e){var t={};function o(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,o),i.l=!0,i.exports}return o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)o.d(n,i,function(t){return e[t]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=4)}([function(e,t){e.exports=require("@babel/runtime/helpers/defineProperty")},function(e,t){e.exports=require("sotez")},function(e,t){e.exports=require("@babel/runtime/helpers/asyncToGenerator")},function(e,t){e.exports=require("libsodium-wrappers")},function(e,t,o){"use strict";o.r(t);var n=o(2),i=o.n(n),s=o(0),r=o.n(s),l=o(1),a=o.n(l),h=o(3),c=o.n(h);const d={MAINNET:{cycleLength:4096,threshold:70368744177663,mempool:"mempool/pending_operations",commitment:32,powHeader:"00000003"},ALPHANET:{cycleLength:2048,threshold:70368744177663,mempool:"mempool/pending_operations",commitment:32,powHeader:"00000003"},ZERONET:{cycleLength:128,threshold:70368744177663,mempool:"mempool/pending_operations",commitment:32,powHeader:"00000003"}};class u{constructor(){r()(this,"_bknonces",void 0),this._bknonces=[]}get bknonces(){return this._bknonces?this._bknonces:[]}set bknonces(e){if(!Array.isArray(e))throw new Error("Nonces must be an array.");this._bknonces=e}}const p=e=>new Promise(t=>setTimeout(t,e));class m extends a.a{constructor(e,t="main",o="main",n={}){var s;super(e,t,o),s=this,r()(this,"store",void 0),r()(this,"startLevel",void 0),r()(this,"bakeIntervalId",void 0),r()(this,"injectedBlocks",void 0),r()(this,"lockBaker",void 0),r()(this,"head",void 0),r()(this,"pendingBlocks",void 0),r()(this,"badOps",void 0),r()(this,"endorsedBlocks",void 0),r()(this,"noncesToReveal",void 0),r()(this,"lastLevel",void 0),r()(this,"bakedBlocks",void 0),r()(this,"mempoolEndorsementCount",void 0),r()(this,"mempoolChecks",void 0),r()(this,"bakerDebugMode",void 0),r()(this,"CONSTANTS",void 0),r()(this,"getConstants",e=>{const t=d.MAINNET;return"alpha"===e?d.ALPHANET:"zero"===e?d.ZERONET:t}),r()(this,"logOutput",(...e)=>{this.bakerDebugMode&&console.log(...e)}),r()(this,"loadNonces",()=>{this.noncesToReveal=this.store.bknonces}),r()(this,"addNonce",e=>{this.noncesToReveal.push(e),this.store.bknonces=this.noncesToReveal}),r()(this,"revealNonces",(e,t)=>{const o=[];for(let n=0;n<this.noncesToReveal.length;n++){const i=this.cycleToLevelStart(this.levelToCycle(this.noncesToReveal[n].level)+1),s=this.cycleToLevelEnd(this.levelToCycle(this.noncesToReveal[n].level)+1);t.header.level>s&&this.logOutput(`!Abandon nonce ${this.noncesToReveal[n].seed} for level ${this.noncesToReveal[n].level}`),t.header.level>=i&&!1===this.noncesToReveal[n].revealed?(this.logOutput(`!Revealing nonce ${this.noncesToReveal[n].seed} for level ${this.noncesToReveal[n].level}`),this.reveal(e,this.head,this.noncesToReveal[n])):o.push(this.noncesToReveal[n])}o.length!==this.noncesToReveal.length&&(this.noncesToReveal=o,this.store.bknonces=this.noncesToReveal)}),r()(this,"levelToCycle",e=>Math.floor((e-1)/this.CONSTANTS.cycleLength)),r()(this,"cycleToLevelStart",e=>e*this.CONSTANTS.cycleLength+1),r()(this,"cycleToLevelEnd",e=>this.cycleToLevelStart(e)+this.CONSTANTS.cycleLength-1),r()(this,"run",function(){var e=i()(function*(e){const t=[];for(let e=0;e<s.pendingBlocks.length;e++){const o=s.pendingBlocks[e];o.level<=s.head.header.level||(s.injectedBlocks.indexOf(o.level)>=0||(s.dateToTime(s.getDateNow())>=s.dateToTime(o.timestamp)?(s.injectedBlocks.push(o.level),s.query(`/injection/block?chain=${o.chain_id}`,o.data).then(e=>{o.seed?(s.addNonce({hash:e,seed_nonce_hash:o.seed_nonce_hash,seed:o.seed,level:o.level,revealed:!1}),s.logOutput(`[92m+Injected block ${e} at level ${o.level} with seed ${o.seed}[0m`)):s.logOutput(`[92m+Injected block ${e} at level ${o.level} with no seed[0m`)}).catch(e=>{const t=JSON.parse(e);Array.isArray(t)&&t.length&&void 0!==t[0].operation&&s.badOps.push(t[0].operation),Array.isArray(t)&&t.length&&void 0!==t[0].id&&s.logOutput(t[0].id,o),s.logOutput("[91m-Failed to bake with error[0m"),console.error("Inject failed",t)})):t.push(o)))}var o,n;(s.pendingBlocks=t,s.lockBaker)||(s.lockBaker=!0,s.head=yield s.getHead(),s.lockBaker=!1,s.revealNonces(e,s.head),0===s.startLevel&&(s.startLevel=s.head.header.level+1,s.logOutput(`[96mInitiate stand-down - starting at level ${s.startLevel}[0m`)),s.startLevel>s.head.header.level||(s.endorsedBlocks.indexOf(s.head.header.level)<0&&(o=i()(function*(t){try{const o=yield s.query(`/chains/${t.chain_id}/blocks/${t.hash}/helpers/endorsing_rights?level=${t.header.level}&delegate=${e.pkh}`);if(t.header.level!==s.head.header.level)return void s.logOutput("[93mHead changed![0m");o.length>0&&s.endorsedBlocks.indexOf(t.header.level)<0&&(s.endorsedBlocks.push(t.header.level),s.endorse(e,t,o[0].slots).then(e=>{s.logOutput(`[92m+Endorsed block ${t.hash} (${e})[0m`)}).catch(()=>{s.logOutput(`[91m!Failed to endorse block ${t.hash}[0m`)}))}catch(e){s.logOutput(`[91m!Failed to endorse block ${t.hash}[0m`)}}),function(e){return o.apply(this,arguments)})(s.head),s.bakedBlocks.indexOf(s.head.header.level+1)<0&&(n=i()(function*(t){try{const o=yield s.query(`/chains/${t.chain_id}/blocks/${t.hash}/helpers/baking_rights?level=${t.header.level+1}&delegate=${e.pkh}`);if(t.header.level!==s.head.header.level)return void s.logOutput("[93mHead changed![0m");if(s.bakedBlocks.indexOf(t.header.level+1)<0){if(o.length<=0)return s.bakedBlocks.push(t.header.level+1),void s.logOutput("[93mNothing to bake this level[0m");s.dateToTime(s.getDateNow())>=s.dateToTime(o[0].estimated_time)&&o[0].level===t.header.level+1&&(s.bakedBlocks.push(t.header.level+1),s.logOutput(`[96m-Trying to bake ${o[0].level}/${o[0].priority}... (${o[0].estimated_time})[0m`),s.bake(e,t,o[0].priority,o[0].estimated_time).then(e=>{s.pendingBlocks.push(e),s.logOutput(`[96m-Added potential block for level ${t.header.level+1}: [[+${e.data.operations[0].length}], [+${e.data.operations[1].length}], [+${e.data.operations[2].length}], [+${e.data.operations[3].length}]][0m`)}).catch(()=>s.logOutput(`[91m-Couldn't bake ${t.header.level+1}[0m`)))}}catch(e){s.logOutput("[91m!Error[0m",e)}}),function(e){return n.apply(this,arguments)})(s.head)))});return function(t){return e.apply(this,arguments)}}()),r()(this,"reveal",(e,t,o)=>{let n;const r={branch:t.hash,contents:[{kind:"seed_nonce_revelation",level:o.level,nonce:o.seed}]};return this.query(`/chains/${t.chain_id}/blocks/${t.hash}/helpers/forge/operations`,r).then(function(){var o=i()(function*(o){if(r.protocol=t.protocol,!e){const e=yield l.ledger.signOperation({path:"44'/1729'/0'/0'",rawTxHex:`02${o}`,curve:0});return n=o+e,r.signature=l.utility.b58cencode(l.utility.hex2buf(e),l.prefix.edsig),s.query(`/chains/${t.chain_id}/blocks/${t.hash}/helpers/preapply/operations`,[r])}const i=yield l.crypto.sign(o,e.sk,l.utility.mergebuf(l.watermark.endorsement,l.utility.b58cdecode(t.chain_id,l.prefix.Net)));return n=i.sbytes,r.signature=i.prefixSig,s.query(`/chains/${t.chain_id}/blocks/${t.hash}/helpers/preapply/operations`,[r])});return function(e){return o.apply(this,arguments)}}()).then(()=>this.query("/injection/operation",n)).then(e=>(this.logOutput(`[96m!Nonce has been revealed for level ${o.level}[0m`),o.revealed=!0,e)).catch(e=>{this.logOutput(`[91m!Couldn't reveal nonce for ${o.level}[0m`),this.logOutput(e),o.revealed=!0})}),r()(this,"endorse",(e,t,o)=>{let n;const r={branch:t.hash,contents:[{kind:"endorsement",level:t.header.level,slot:Math.max(...o)}]};return this.query(`/chains/${t.chain_id}/blocks/${t.hash}/helpers/forge/operations`,r).then(function(){var o=i()(function*(o){if(r.protocol=t.protocol,!e){const e=yield l.ledger.signOperation({path:"44'/1729'/0'/0'",rawTxHex:`02${o}`,curve:0});return n=o+e,r.signature=l.utility.b58cencode(l.utility.hex2buf(e),l.prefix.edsig),s.query(`/chains/${t.chain_id}/blocks/${t.hash}/helpers/preapply/operations`,[r])}const i=yield l.crypto.sign(o,e.sk,l.utility.mergebuf(l.watermark.endorsement,l.utility.b58cdecode(t.chain_id,l.prefix.Net)));return n=i.sbytes,r.signature=i.prefixSig,s.query(`/chains/${t.chain_id}/blocks/${t.hash}/helpers/preapply/operations`,[r])});return function(e){return o.apply(this,arguments)}}()).then(()=>this.query("/injection/operation",n)).then(e=>e).catch(e=>this.logOutput(e))}),r()(this,"mempoolCheck",e=>{let t=0;return e.applied.forEach(e=>{e.contents.some(e=>"endorsement"===e.kind)&&t++}),!(t<=1)&&(this.mempoolEndorsementCount===t?this.mempoolChecks.push(!0):this.mempoolChecks=[],this.mempoolEndorsementCount=t,this.mempoolChecks.length>2&&(console.log("Mempool Endorsements:",t),this.mempoolChecks=[],!0))}),r()(this,"bake",function(){var e=i()(function*(e,t,o,n){let r=[[],[],[],[]],a="",h="",d="";const u=t.header.level+1;if(u%s.CONSTANTS.commitment==1){a=l.utility.hexNonce(64);try{yield c.a.ready}catch(e){throw new Error(e)}const e=c.a.crypto_generichash(32,l.utility.hex2buf(a));d=l.utility.b58cencode(e,l.prefix.nce),h=l.utility.buf2hex(e),s.logOutput(`[96mNonce required for level ${u}[0m`)}const m=yield s.query(`/chains/${t.chain_id}/${s.CONSTANTS.mempool}`);if(!s.mempoolCheck(m))return yield p(500),s.bake(e,t,o,n);const v=[];for(let e=0;e<m.applied.length;e++)if(v.indexOf(m.applied[e].hash)<0){if(m.applied[e].branch!==t.hash)continue;if(s.badOps.indexOf(m.applied[e].hash)>=0)continue;v.push(m.applied[e].hash),r[s.operationPass(m.applied[e])].push({protocol:t.protocol,branch:m.applied[e].branch,contents:m.applied[e].contents,signature:m.applied[e].signature})}const f={protocol_data:{protocol:t.protocol,priority:o,proof_of_work_nonce:"0000000000000000",signature:"edsigtXomBKi5CTRf5cjATJWSyaRvhfYNHqSUGrn4SdbYRcGwQrUGjzEfQDTuqHhuA8b2d8NarZjz8TRf65WkpQmo423BtomS8Q"},operations:r};let g;""!==d&&(f.protocol_data.seed_nonce_hash=d);try{g=yield s.query(`/chains/${t.chain_id}/blocks/${t.hash}/helpers/preapply/block?sort=true&timestamp=${Math.max(s.dateToTime(s.getDateNow()),s.dateToTime(n))}`,f)}catch(e){console.error("[91mPreapply failed[0m",e),s.logOutput("[91m!Couldn't bake - send 0 op bake instead[0m"),f.operations=[[],[],[],[]],g=yield s.query(`/chains/${t.chain_id}/blocks/${t.hash}/helpers/preapply/block?sort=true&timestamp=${Math.max(s.dateToTime(s.getDateNow()),s.dateToTime(n))}`,f)}s.logOutput("[96m!Starting POW...[0m"),r=g.operations;const b=g.shell_header;return new Promise(n=>{b.protocol_data=s.createProtocolData(o);const a=[];for(let e=0;e<r.length;e++){const t=[];for(let o=0;o<r[e].applied.length;o++)t.push({branch:r[e].applied[o].branch,data:r[e].applied[o].data});a.push(t)}return r=a,s.query(`/chains/${t.chain_id}/blocks/${t.hash}/helpers/forge_block_header`,b).then(function(){var a=i()(function*(a){const c=a.block.substring(0,a.block.length-22);let d,u;const p=(new Date).getTime();s.powLoop(c,o,h,function(){var o=i()(function*(o,i){const a=(((new Date).getTime()-p)/1e3).toFixed(3);if(s.logOutput(`[96m+POW found in ${i} attempts (${a} seconds - ${(i/parseFloat(a)/1e3).toFixed(3)} Kh/s)[0m`),e)d=yield l.crypto.sign(o,e.sk,l.utility.mergebuf(l.watermark.block,l.utility.b58cdecode(t.chain_id,l.prefix.Net))),u=d.sbytes,n({data:u,operations:r});else{const e=l.utility.buf2hex(l.utility.b58cdecode(t.chain_id,l.prefix.Net))+o,i=yield l.ledger.signOperation({path:"44'/1729'/0'/0'",rawTxHex:`01${e}`,curve:0});n({data:u=o+i,operations:r})}});return function(e,t){return o.apply(this,arguments)}}())});return function(e){return a.apply(this,arguments)}}())}).then(e=>({timestamp:n,data:e,seed_nonce_hash:h,seed:a,level:u,chain_id:t.chain_id}))});return function(t,o,n,i){return e.apply(this,arguments)}}()),r()(this,"powLoop",(e,t,o,n)=>{const r=e+this.createProtocolData(t,this.CONSTANTS.powHeader,"00000000",o),a=l.utility.hex2buf(`${r}00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000`),h=e.length/2+2+4;let c;(c=function(){var e=i()(function*(e,t){e++,t++;for(let e=3;e>=0;e--){if(255!==a[h+e]){a[h+e]++;break}a[h+e]=0}if(yield s.checkHash(a)){let t=l.utility.buf2hex(a);t=t.substr(0,t.length-128),n(t,e)}else t<2e3?c(e,t):setImmediate(c,e,0)});return function(t,o){return e.apply(this,arguments)}}())(0,0)}),r()(this,"createProtocolData",(e,t="",o="",n="")=>`${e.toString(16).padStart(4,"0")}${t.padEnd(8,"0")}${o.padEnd(8,"0")}${n?`ff${n.padEnd(64,"0")}`:"00"}`),r()(this,"checkHash",function(){var e=i()(function*(e){try{yield c.a.ready}catch(e){throw new Error(e)}const t=c.a.crypto_generichash(32,e);return s.stampcheck(t)<=s.CONSTANTS.threshold});return function(t){return e.apply(this,arguments)}}()),r()(this,"stampcheck",e=>{let t=0;for(let o=0;o<8;o++)t=256*t+e[o];return t}),r()(this,"dateToTime",e=>new Date(e).getTime()/1e3),r()(this,"getDateNow",()=>`${(new Date).toISOString().substr(0,19)}Z`),r()(this,"operationPass",e=>{if(1!==e.contents.length)return 3;switch(e.contents[0].kind){case"endorsement":return 0;case"proposals":case"ballot":return 1;case"seed_nonce_revelation":case"double_endorsement_evidence":case"double_baking_evidence":case"activate_account":return 2;default:return 3}}),r()(this,"load",e=>{this.store=e,this.loadNonces()}),r()(this,"start",e=>(this.logOutput("[96mStarting baker...[0m"),this.bakeIntervalId&&(clearInterval(this.bakeIntervalId),this.bakeIntervalId=!1),this.run(e),this.bakeIntervalId=setInterval(()=>this.run(e),1e3),this.bakeIntervalId)),r()(this,"stop",()=>{this.logOutput("[96mStopping baker...[0m"),this.bakeIntervalId&&(clearInterval(this.bakeIntervalId),this.bakeIntervalId=!1)}),this.store=new u,this.startLevel=0,this.bakeIntervalId=!1,this.injectedBlocks=[],this.lockBaker=!1,this.head=null,this.pendingBlocks=[],this.badOps=[],this.endorsedBlocks=[],this.noncesToReveal=[],this.lastLevel=0,this.bakedBlocks=[],this.mempoolEndorsementCount=0,this.mempoolChecks=[],this.bakerDebugMode=n.debugMode||!0,this.CONSTANTS=this.getConstants(o)}}o.d(t,"Baker",function(){return m})}])});