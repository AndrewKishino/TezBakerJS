!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var o=t();for(var s in o)("object"==typeof exports?exports:e)[s]=o[s]}}(global,(function(){return function(e){var t={};function o(s){if(t[s])return t[s].exports;var i=t[s]={i:s,l:!1,exports:{}};return e[s].call(i.exports,i,i.exports,o),i.l=!0,i.exports}return o.m=e,o.c=t,o.d=function(e,t,s){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(o.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)o.d(s,i,function(t){return e[t]}.bind(null,i));return s},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=2)}([function(e,t){e.exports=require("sotez")},function(e,t){e.exports=require("libsodium-wrappers")},function(e,t,o){"use strict";o.r(t);var s=o(0),i=o.n(s),n=o(1),h=o.n(n),r=function(e,t,o,s){return new(o||(o=Promise))((function(i,n){function h(e){try{l(s.next(e))}catch(e){n(e)}}function r(e){try{l(s.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(h,r)}l((s=s.apply(e,t||[])).next())}))};const l={cycleLength:4096,threshold:70368744177663,mempool:"mempool/pending_operations",commitment:32,powHeader:"00000003"},a={cycleLength:2048,threshold:70368744177663,mempool:"mempool/pending_operations",commitment:32,powHeader:"00000003"},c={cycleLength:128,threshold:70368744177663,mempool:"mempool/pending_operations",commitment:32,powHeader:"00000003"};class d{constructor(){this._bknonces=[]}get bknonces(){return this._bknonces?this._bknonces:[]}set bknonces(e){if(!Array.isArray(e))throw new Error("Nonces must be an array.");this._bknonces=e}}const u=e=>new Promise(t=>setTimeout(t,e));class p extends i.a{constructor(e,t="main",o="zeronet",i={}){super(e,t),this.getConstants=e=>"mainnet"===e?l:"zeronet"===e?c:a,this.logOutput=(...e)=>{this.bakerDebugMode&&console.log(...e)},this.loadNonces=()=>{this.noncesToReveal=this.store.bknonces},this.addNonce=e=>{this.noncesToReveal.push(e),this.store.bknonces=this.noncesToReveal},this.revealNonces=e=>{const t=[];for(let o=0;o<this.noncesToReveal.length;o++){const s=this.cycleToLevelStart(this.levelToCycle(this.noncesToReveal[o].level)+1),i=this.cycleToLevelEnd(this.levelToCycle(this.noncesToReveal[o].level)+1);e.header.level>i&&this.logOutput(`!Abandon nonce ${this.noncesToReveal[o].seed} for level ${this.noncesToReveal[o].level}`),e.header.level>=s&&!1===this.noncesToReveal[o].revealed?(this.logOutput(`!Revealing nonce ${this.noncesToReveal[o].seed} for level ${this.noncesToReveal[o].level}`),this.reveal(this.head,this.noncesToReveal[o])):t.push(this.noncesToReveal[o])}t.length!==this.noncesToReveal.length&&(this.noncesToReveal=t,this.store.bknonces=this.noncesToReveal)},this.levelToCycle=e=>Math.floor((e-1)/this.CONSTANTS.cycleLength),this.cycleToLevelStart=e=>e*this.CONSTANTS.cycleLength+1,this.cycleToLevelEnd=e=>this.cycleToLevelStart(e)+this.CONSTANTS.cycleLength-1,this.run=()=>r(this,void 0,void 0,(function*(){const e=[];for(let t=0;t<this.pendingBlocks.length;t++){const o=this.pendingBlocks[t];o.level<=this.head.header.level||(this.injectedBlocks.indexOf(o.level)>=0||(this.dateToTime(this.getDateNow())>=this.dateToTime(o.timestamp)?(this.injectedBlocks.push(o.level),this.query(`/injection/block?chain=${o.chain_id}`,o.data).then(e=>{o.seed?(this.addNonce({hash:e,seed_nonce_hash:o.seed_nonce_hash,seed:o.seed,level:o.level,revealed:!1}),this.logOutput(`[92m+Injected block ${e} at level ${o.level} with seed ${o.seed}[0m`)):this.logOutput(`[92m+Injected block ${e} at level ${o.level} with no seed[0m`)}).catch(e=>{const t=JSON.parse(e);Array.isArray(t)&&t.length&&void 0!==t[0].operation&&this.badOps.push(t[0].operation),Array.isArray(t)&&t.length&&void 0!==t[0].id&&this.logOutput(t[0].id,o),this.logOutput("[91m-Failed to bake with error[0m"),console.error("Inject failed",t)})):e.push(o)))}this.pendingBlocks=e,this.lockBaker||(this.lockBaker=!0,this.head=yield this.getHead(),this.lockBaker=!1,this.revealNonces(this.head),0===this.startLevel&&(this.startLevel=this.head.header.level+1,this.logOutput(`[96mInitiate stand-down - starting at level ${this.startLevel}[0m`)),this.startLevel>this.head.header.level||(this.endorsedBlocks.indexOf(this.head.header.level)<0&&(e=>{r(this,void 0,void 0,(function*(){try{const t=yield this.query(`/chains/${e.chain_id}/blocks/${e.hash}/helpers/endorsing_rights?level=${e.header.level}&delegate=${this.key.publicKeyHash()}`);if(e.header.level!==this.head.header.level)return void this.logOutput("[93mHead changed![0m");t.length>0&&this.endorsedBlocks.indexOf(e.header.level)<0&&(this.endorsedBlocks.push(e.header.level),this.endorse(e).then(t=>{this.logOutput(`[92m+Endorsed block ${e.hash} (${t})[0m`)}).catch(()=>{this.logOutput(`[91m!Failed to endorse block ${e.hash}[0m`)}))}catch(t){this.logOutput(`[91m!Failed to endorse block ${e.hash}[0m`)}}))})(this.head),this.bakedBlocks.indexOf(this.head.header.level+1)<0&&(e=>{r(this,void 0,void 0,(function*(){try{const t=yield this.query(`/chains/${e.chain_id}/blocks/${e.hash}/helpers/baking_rights?level=${e.header.level+1}&delegate=${this.key.publicKeyHash()}`);if(e.header.level!==this.head.header.level)return void this.logOutput("[93mHead changed![0m");if(this.bakedBlocks.indexOf(e.header.level+1)<0){if(t.length<=0)return this.bakedBlocks.push(e.header.level+1),void this.logOutput("[93mNothing to bake this level[0m");this.dateToTime(this.getDateNow())>=this.dateToTime(t[0].estimated_time)&&t[0].level===e.header.level+1&&(this.bakedBlocks.push(e.header.level+1),this.logOutput(`[96m-Trying to bake ${t[0].level}/${t[0].priority}... (${t[0].estimated_time})[0m`),this.bake(e,t[0].priority,t[0].estimated_time).then(t=>{this.pendingBlocks.push(t),this.logOutput(`[96m-Added potential block for level ${e.header.level+1}: [[+${t.data.operations[0].length}], [+${t.data.operations[1].length}], [+${t.data.operations[2].length}], [+${t.data.operations[3].length}]][0m`)}).catch(()=>this.logOutput(`[91m-Couldn't bake ${e.header.level+1}[0m`)))}}catch(e){this.logOutput("[91m!Error[0m",e)}}))})(this.head)))})),this.reveal=(e,t)=>{let o;const i={branch:e.hash,contents:[{kind:"seed_nonce_revelation",level:t.level,nonce:t.seed}]};return this.query(`/chains/${e.chain_id}/blocks/${e.hash}/helpers/forge/operations`,i).then(t=>r(this,void 0,void 0,(function*(){i.protocol=e.protocol;const n=yield this.key.sign(t,s.utility.mergebuf(s.constants.watermark.endorsement,s.utility.b58cdecode(e.chain_id,s.constants.prefix.Net)));return o=n.sbytes,i.signature=n.prefixSig,this.query(`/chains/${e.chain_id}/blocks/${e.hash}/helpers/preapply/operations`,[i])}))).then(()=>this.query("/injection/operation",o)).then(e=>(this.logOutput(`[96m!Nonce has been revealed for level ${t.level}[0m`),t.revealed=!0,e)).catch(e=>{this.logOutput(`[91m!Couldn't reveal nonce for ${t.level}[0m`),this.logOutput(e),t.revealed=!0})},this.endorse=e=>{let t;const o={branch:e.hash,contents:[{kind:"endorsement",level:e.header.level}]};return this.query(`/chains/${e.chain_id}/blocks/${e.hash}/helpers/forge/operations`,o).then(i=>r(this,void 0,void 0,(function*(){o.protocol=e.protocol;const n=yield this.key.sign(i,s.utility.mergebuf(s.constants.watermark.endorsement,s.utility.b58cdecode(e.chain_id,s.constants.prefix.Net)));return t=n.sbytes,o.signature=n.prefixSig,this.query(`/chains/${e.chain_id}/blocks/${e.hash}/helpers/preapply/operations`,[o])}))).then(()=>this.query("/injection/operation",t)).then(e=>e).catch(e=>this.logOutput(e))},this.mempoolCheck=e=>{if(this.mempoolCheckCount>=10)return this.mempoolCheckCount=0,!0;let t=0;return e.applied.forEach(e=>{e.contents.some(e=>"endorsement"===e.kind)&&t++}),t<this.requiredEndorsements?(this.mempoolCheckCount++,!1):(this.requiredEndorsements=0,console.log("Mempool Endorsements:",t),!0)},this.bake=(e,t,o)=>r(this,void 0,void 0,(function*(){let i=[[],[],[],[]],n="",l="",a="";const c=e.header.level+1,d="zero"===this.network?1:0;if(c%this.CONSTANTS.commitment===d){n=s.utility.hexNonce(64);try{yield h.a.ready}catch(e){throw new Error(e)}const e=h.a.crypto_generichash(32,s.utility.hex2buf(n));a=s.utility.b58cencode(e,s.constants.prefix.nce),l=s.utility.buf2hex(e),this.logOutput(`[96mNonce required for level ${c}[0m`)}const p=yield this.query(`/chains/${e.chain_id}/${this.CONSTANTS.mempool}`);if(!this.mempoolCheck(p))return yield u(500),this.bake(e,t,o);const m=[];for(let t=0;t<p.applied.length;t++)if(m.indexOf(p.applied[t].hash)<0){if(p.applied[t].branch!==e.hash)continue;if(this.badOps.indexOf(p.applied[t].hash)>=0)continue;m.push(p.applied[t].hash),i[this.operationPass(p.applied[t])].push({protocol:e.protocol,branch:p.applied[t].branch,contents:p.applied[t].contents,signature:p.applied[t].signature})}const v={protocol_data:{protocol:e.protocol,priority:t,proof_of_work_nonce:"0000000000000000",signature:"edsigtXomBKi5CTRf5cjATJWSyaRvhfYNHqSUGrn4SdbYRcGwQrUGjzEfQDTuqHhuA8b2d8NarZjz8TRf65WkpQmo423BtomS8Q"},operations:i};let f;""!==a&&(v.protocol_data.seed_nonce_hash=a);try{f=yield this.query(`/chains/${e.chain_id}/blocks/${e.hash}/helpers/preapply/block?sort=true&timestamp=${Math.max(this.dateToTime(this.getDateNow()),this.dateToTime(o))}`,v)}catch(s){if(s[0]&&"proto.006-PsCARTHA.operation.not_enought_endorsements_for_priority"===s[0].id)return this.requiredEndorsements=s[0].required,console.log(`Required endorsements: ${this.requiredEndorsements}`),yield u(500),this.bake(e,t,o);console.error("[91mPreapply failed[0m",s),this.logOutput("[91m!Couldn't bake - send 0 op bake instead[0m"),v.operations=[[],[],[],[]],f=yield this.query(`/chains/${e.chain_id}/blocks/${e.hash}/helpers/preapply/block?sort=true&timestamp=${Math.max(this.dateToTime(this.getDateNow()),this.dateToTime(o))}`,v)}this.logOutput("[96m!Starting POW...[0m"),({operations:i}=f);const{shell_header:g}=f;return new Promise(o=>{g.protocol_data=this.createProtocolData(t);const n=[];for(let e=0;e<i.length;e++){const t=[];for(let o=0;o<i[e].applied.length;o++)t.push({branch:i[e].applied[o].branch,data:i[e].applied[o].data});n.push(t)}return i=n,this.query(`/chains/${e.chain_id}/blocks/${e.hash}/helpers/forge_block_header`,g).then(n=>r(this,void 0,void 0,(function*(){const h=n.block.substring(0,n.block.length-22);let a,c;const d=(new Date).getTime();this.powLoop(h,t,l,(t,n)=>r(this,void 0,void 0,(function*(){const h=(((new Date).getTime()-d)/1e3).toFixed(3);this.logOutput(`[96m+POW found in ${n} attempts (${h} seconds - ${(n/parseFloat(h)/1e3).toFixed(3)} Kh/s)[0m`),a=yield this.key.sign(t,s.utility.mergebuf(s.constants.watermark.block,s.utility.b58cdecode(e.chain_id,s.constants.prefix.Net))),c=a.sbytes,o({data:c,operations:i})})))})))}).then(t=>({timestamp:o,data:t,seed_nonce_hash:l,seed:n,level:c,chain_id:e.chain_id}))})),this.powLoop=(e,t,o,i)=>{const n=e+this.createProtocolData(t,this.CONSTANTS.powHeader,"00000000",o),h=s.utility.hex2buf(`${n}00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000`),l=e.length/2+2+4;let a;(a=(e,t)=>r(this,void 0,void 0,(function*(){e++,t++;for(let e=3;e>=0;e--){if(255!==h[l+e]){h[l+e]++;break}h[l+e]=0}if(yield this.checkHash(h)){let t=s.utility.buf2hex(h);t=t.substr(0,t.length-128),i(t,e)}else t<2e3?a(e,t):setImmediate(a,e,0)})))(0,0)},this.createProtocolData=(e,t="",o="",s="")=>`${e.toString(16).padStart(4,"0")}${t.padEnd(8,"0")}${o.padEnd(8,"0")}${s?`ff${s.padEnd(64,"0")}`:"00"}`,this.checkHash=e=>r(this,void 0,void 0,(function*(){try{yield h.a.ready}catch(e){throw new Error(e)}const t=h.a.crypto_generichash(32,e);return this.stampcheck(t)<=this.CONSTANTS.threshold})),this.stampcheck=e=>{let t=0;for(let o=0;o<8;o++)t=256*t+e[o];return t},this.dateToTime=e=>new Date(e).getTime()/1e3,this.getDateNow=()=>`${(new Date).toISOString().substr(0,19)}Z`,this.operationPass=e=>{if(1!==e.contents.length)return 3;switch(e.contents[0].kind){case"endorsement":return 0;case"proposals":case"ballot":return 1;case"seed_nonce_revelation":case"double_endorsement_evidence":case"double_baking_evidence":case"activate_account":return 2;default:return 3}},this.load=e=>{this.store=e,this.loadNonces()},this.start=()=>(this.logOutput("[96mStarting baker...[0m"),this.bakeIntervalId&&(clearInterval(this.bakeIntervalId),this.bakeIntervalId=!1),this.bakeIntervalId=setInterval(()=>this.run(),1e3),this.bakeIntervalId),this.stop=()=>{this.logOutput("[96mStopping baker...[0m"),this.bakeIntervalId&&(clearInterval(this.bakeIntervalId),this.bakeIntervalId=!1)},this.store=new d,this.startLevel=0,this.bakeIntervalId=!1,this.injectedBlocks=[],this.lockBaker=!1,this.head=null,this.pendingBlocks=[],this.badOps=[],this.endorsedBlocks=[],this.noncesToReveal=[],this.lastLevel=0,this.bakedBlocks=[],this.requiredEndorsements=0,this.mempoolCheckCount=0,this.bakerDebugMode=i.debugMode||!0,this.CONSTANTS=this.getConstants(o)}}o.d(t,"Baker",(function(){return p}))}])}));